<script>
     // PÁGINA DO COTADOR
     // Função para calculo da tarifa final
    var btnCotar
    window.setTimeout(function(){
    document.getElementById("btn-assinar").style.display = "none"
    btnCotar = document.querySelector("#btn-cotar")
    btnCotar.addEventListener("click", function(e){
        e.preventDefault
        calculaValorFinal()
        mostrarBotaoAssinar()
        linkEnvio()
    })

    function calculaValorFinal(){
    var diasViagem = document.getElementById("form-field-diasVigem").value
    var cotacaoDolar = document.getElementById("form-field-valor_dolar").value
    var destino = document.getElementById("form-field-destino").value
    var dataIda = document.getElementById("form-field-dataIda").value
    var dataVolta = document.getElementById("form-field-dataVolta").value
    var valorPlanoDia0 = document.getElementById("form-field-plano-0").checked
    var valorPlanoDia1 = document.getElementById("form-field-plano-1").checked
    
    const menor65 = []
    const maior65 = []
    var idades = document.querySelectorAll("#form-field-idadeViaj1, #form-field-idadeViaj2, #form-field-idadeViaj3, #form-field-idadeViaj4, #form-field-idadeViaj5, #form-field-idadeViaj6")
    
    for (var i = 0; i < idades.length; i++) {
            if (idades[i].value > 65) {
                maior65.push(idades[i].value)            
            } else if (idades[i].value > 0) {
                menor65.push(idades[i].value)
            } else {}
        }

    var viajantesMenor65 = menor65.length
    var viajantesMaior65 = maior65.length

    var valorFinal

    var planoEscolhido
    if (valorPlanoDia0 == true) {
        planoEscolhido = document.getElementById("form-field-plano-0").value
    } else if (valorPlanoDia1 == true) {
        planoEscolhido = document.getElementById("form-field-plano-1").value
    } else {}
    var planoComPonto = planoEscolhido.replace(",", ".")

    valorFinal = diasViagem*(cotacaoDolar*planoComPonto)*(viajantesMenor65 + viajantesMaior65*2)
    valorFinalReal = valorFinal.toLocaleString('pt-br', {style: 'currency', currency: 'BRL'})
    document.getElementById("valorfinal").innerHTML = valorFinalReal

    // Adicionar link no botão Assina

    var btnAssinar = document.querySelector("#btn-assinar a")  
    var planoEscolhidoLabel
    if (valorPlanoDia0 == true) {
        planoEscolhidoLabel = document.querySelector("label[for=form-field-plano-0]")
    } else if (valorPlanoDia1 == true) {
        planoEscolhidoLabel = document.querySelector("label[for=form-field-plano-1]")
    } else {}

    var idade2 = document.getElementById("form-field-idadeViaj2").value
    var idade3 = document.getElementById("form-field-idadeViaj3").value
    var idade4 = document.getElementById("form-field-idadeViaj4").value
    var idade5 = document.getElementById("form-field-idadeViaj5").value
    var idade6 = document.getElementById("form-field-idadeViaj6").value
    var precoNum = valorFinal.toFixed(2)
    var nomePLano = planoEscolhidoLabel.innerHTML

    var urlEnvio = 'https://starcorretoradeseguros.com.br/dev-cotador-seguro-viagem-argentina-formulario/?dstn='+destino+'&ida='+dataIda+'&vlt='+dataVolta+'&pln='+nomePLano+'&diasvj='+diasViagem+'&idad2='+idade2+'&idad3='+idade3+'&idad4='+idade4+'&idad5='+idade5+'idad6='+idade6+'&prec='+precoNum

    btnAssinar.href = urlEnvio
    }

    function mostrarBotaoAssinar () {
        document.getElementById("btn-assinar").style.display = "block"
    }
},2000)

// Botão próxima etapa do cotador
var btnPlano
    window.setTimeout(function(){
    btnPlano = document.querySelector("#btn-plano")
    btnPlano.addEventListener("click", function(e){
        e.preventDefault
        escolherPlano()
    })

    document.getElementById("etapa1").style.display = "block"
    document.getElementById("etapa2").style.display = "none"

    function escolherPlano() {
        document.getElementById("etapa1").style.display = "none"
        document.getElementById("etapa2").style.display = "block"
    }
},2000)

// Botão voltar

var btnVoltar
    window.setTimeout(function(){
    btnVoltar = document.querySelector("#btn-voltar")
    btnVoltar.addEventListener("click", function(e){
        e.preventDefault
        escolherPlano()
    })

    function escolherPlano() {
        document.getElementById("etapa1").style.display = "block"
        document.getElementById("etapa2").style.display = "none"
    }
},2000)

// PÁGINA DO FORMULÁRIO
// Calcula idade com data de nascimento
var resposta
var anyCampoNasc
var evt
jQuery(document).ready(function($) {
window.setTimeout(function(){
    anyCampoNasc = document.querySelectorAll('[id^="form-field-cpf"]')
    for (var n = 0; n < anyCampoNasc.length; n++){
        console.log(anyCampoNasc[n])
        let i = n+1
        $('#form-field-cpf'+i).mask("999.999.999-99");
        anyCampoNasc[n].addEventListener("blur", function(e){
            evt = e.target
            console.log(evt)
            var numCampo = evt.getAttribute('id').substr(-1)
            console.log(numCampo)
            apiCPF(numCampo)
        })
    }

    async function calculaIdadePorNascimento(idViajante, dataNasc) {
        console.log(idViajante);
        var camposIdade = document.querySelector('#form-field-idade'+idViajante)
        var valorNasc = dataNasc.split("/")
        console.log(valorNasc);
        var d = new Date,
        ano_atual = d.getFullYear(),
        mes_atual = d.getMonth() + 1,
        dia_atual = d.getDate(),

        ano_aniversario = valorNasc[2],
        mes_aniversario = valorNasc[1],
        dia_aniversario = valorNasc[0],

        quantos_anos = ano_atual - ano_aniversario;

        if (mes_atual < mes_aniversario || mes_atual == mes_aniversario && dia_atual < dia_aniversario) {
            quantos_anos--;
        }
        camposIdade.value = quantos_anos
    }

    // Api CPF
  async  function apiCPF (idCampo) {
        var token = "589b919a78706e51e72c5f5e60c01046"
        var urlBase = "https://api.cpfcnpj.com.br/";
        var cpf = document.querySelector("#form-field-cpf"+idCampo).value.replace(/\D/g, '');
        if (cpf != "") {
            var validacpf = /^[0-9]{11}$/;      
            if(validacpf.test(cpf)) {
                document.querySelector("#form-field-nome"+idCampo).value = "...";
                document.querySelector("#form-field-data_nasc"+idCampo).value = "...";
                var options = {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'default'
                }
                await fetch(urlBase + token +"/7/" + cpf , options)
                .then( function(response){
                    response.json()
                    .then(
                        function(data){ 
                            console.log(data)
                            document.querySelector("#form-field-nome"+idCampo).value = data.nome;
                            var nomeAPI = data.nome;
                            console.log("NOME API: " + nomeAPI)
                            var nomeCompleto = nomeAPI.split(" ");
                            console.log("NOME COMPLETO: " + nomeCompleto)
                            var primeiroNome = nomeCompleto[0];
                            console.log("PRIMEIRO NOME: " + primeiroNome)
                            var sobrenomeArray = nomeCompleto.slice(1);
                            var sobrenome = sobrenomeArray.join(" ");
                            console.log("SOBRENOME: " + sobrenome)
                            document.querySelector("#form-field-nome"+idCampo).value = data.nome;
                            //document.querySelector("#billing_nome"+idCampo).value = data.nome;
                            document.querySelector("#form-field-data_nasc"+idCampo).value = data.nascimento;
                            calculaIdadePorNascimento(idCampo, data.nascimento)
                            //document.querySelector("#billing_nasc"+idCampo).value = data.nascimento;
                            //document.querySelector("#billing_first_name"+idCampo).value = primeiroNome;
                            //document.querySelector("#billing_last_name"+idCampo).value = sobrenome;
                            //document.querySelector("#billing_cpf"+idCampo).value = cpf;
                        },
                    )
                });
            };
        }
    }
},2000)
});

</script>
    